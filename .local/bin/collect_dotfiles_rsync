#!/bin/bash

# Define the target directory for your dotfiles repo
DOTFILES_DIR="$HOME/Work/GITHUB/sparkrice"
mkdir -p "$DOTFILES_DIR"

# Directories/files to copy recursively (based on voidrice/common dotfile locations; add more if you have others like .var or .etc)
# Use relative paths from $HOME
SOURCES_REL=(
    ".config"
    ".gtkrc-2.0"
    ".xprofile"
    ".zprofile"
    # Add any other top-level dots or dirs here, e.g., ".var/app"
)

# Specific items from .local/share to include (dirs will be copied recursively, files as-is)
LOCAL_SHARE_INCLUDES=(
    ".local/share/applications"
    ".local/share/default_latex"
    ".local/share/larbs"
    ".local/share/bg"
    ".local/share/thiemeyer_road_to_samarkand.jpg"
)

# List of rsync exclude patterns (anchored with / for root of each source; expand as needed)
# These prevent sensitive/irrelevant sub-items from being copied
EXCLUDES=(
    "/google-chrome"
    "/chromium"
    "/BraveSoftware"
    "/passoword-store"
    # Add more for .config, e.g., "/mpd/playlists" if it has personal data
    "/gnupg"
    "/keyrings"
    # Add more if needed for other sources
)

# Create a temporary excludes file for rsync
EXCLUDES_FILE="/tmp/sparkrice_excludes.txt"
printf "%s\n" "${EXCLUDES[@]}" > "$EXCLUDES_FILE"

# Copy the main sources, excluding patterns (recursive -r, preserve symlinks -l, verbose -v; no permissions/owner/group preservation)
for item in "${SOURCES_REL[@]}"; do
    src="$HOME/$item"
    if [ -e "$src" ]; then
        rsync -rlv --exclude-from="$EXCLUDES_FILE" "$src" "$DOTFILES_DIR/"
        echo "Copied: $item (with excludes, default permissions)"
    else
        echo "Skipped (not found): $item"
    fi
done

# Copy specific .local/share items (with excludes applied for subdirs)
for item in "${LOCAL_SHARE_INCLUDES[@]}"; do
    src="$HOME/$item"
    dest="$DOTFILES_DIR/$item"
    if [ -e "$src" ]; then
        mkdir -p "$(dirname "$dest")"
        rsync -rlv --exclude-from="$EXCLUDES_FILE" "$src" "$(dirname "$dest")/"
        echo "Copied: $item (with excludes if dir, default permissions)"
    else
        echo "Skipped (not found): $item"
    fi
done

# Special handling for .local/bin: copy contents except askgemini.py (with default permissions)
BIN_SRC_DIR="$HOME/.local/bin"
BIN_DEST_DIR="$DOTFILES_DIR/.local/bin"
mkdir -p "$BIN_DEST_DIR"
if [ -d "$BIN_SRC_DIR" ]; then
    rsync -rlv --exclude="askgemini.py" --exclude-from="$EXCLUDES_FILE" "$BIN_SRC_DIR/" "$BIN_DEST_DIR/"
    echo "Copied: .local/bin (excluding askgemini.py and other excludes, default permissions)"
else
    echo "Skipped (not found): .local/bin"
fi

# Clean up temp excludes file
rm "$EXCLUDES_FILE"

echo "Dotfiles copied to $DOTFILES_DIR (automatic inclusion of new files in scanned dirs, selective for .local/share)."
echo "Review contents (e.g., tree -a $DOTFILES_DIR), remove/edit any sensitive info that slipped through, then commit: cd $DOTFILES_DIR && git add . && git commit -m 'Update dotfiles'."
notify-send "Collector of Dotfiles" "Finished collecting. Check repo"
